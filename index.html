<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game H·ª©ng Tr√°i Tim N√¢ng C·∫•p</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Ch√≠nh */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #ffeaf0;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #ff6b9d;
            overflow: hidden;
            transition: background-color 0.5s;
        }

        /* MENU STYLES */
        #main-menu, #difficulty-menu, #settings-menu, #leaderboard-menu, #start-screen, #game-over, #pause-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .menu-button {
            padding: 15px 30px;
            font-size: 20px;
            background-color: #ff0066;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            min-width: 200px;
        }

        .menu-button:hover {
            background-color: #ff4d94;
            transform: scale(1.05);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px;
            font-size: 16px;
            background-color: transparent;
            color: #ff0066;
            border: 1px solid #ff0066;
            border-radius: 5px;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #ffebf2;
        }

        /* SETTINGS MENU */
        .setting-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            width: 80%;
            max-width: 400px;
        }

        .setting-item label {
            flex: 1;
            text-align: left;
            margin-right: 10px;
        }

        .setting-item input[type="range"] {
            flex: 2;
        }

        .setting-item span {
            flex: 0.5;
            text-align: right;
        }

        #username-input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-left: 10px;
        }

        /* LEADERBOARD */
        #leaderboard-list {
            width: 90%;
            max-height: 70%;
            overflow-y: auto;
            margin: 20px 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-item:nth-child(odd) {
            background-color: #f9f9f9;
        }

        .leaderboard-rank {
            font-weight: bold;
            min-width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            text-align: left;
            margin: 0 10px;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #ff0066;
        }

        /* GAME ELEMENTS */
        #basket {
            opacity: 0;
            position: absolute;
            bottom: 20px;
            width: 80px;
            height: 80px;
            transform: translateX(-50%);
            user-select: none;
            pointer-events: none;
        }

        /* C√°c lo·∫°i v·∫≠t ph·∫©m */
        .heart {
            position: absolute;
            top: -30px;
            width: 30px;
            height: 30px;
            color: #ff0066;
            font-size: 30px;
            user-select: none;
        }

        .special-heart {
            position: absolute;
            top: -30px;
            width: 30px;
            height: 30px;
            color: #FFD700;
            font-size: 30px;
            user-select: none;
            filter: drop-shadow(0 0 5px gold);
        }

        .extra-life {
            position: absolute;
            top: -30px;
            width: 30px;
            height: 30px;
            color: #00BFFF;
            font-size: 30px;
            user-select: none;
            filter: drop-shadow(0 0 5px cyan);
        }

        .extra-time {
            position: absolute;
            top: -30px;
            width: 30px;
            height: 30px;
            color: #32CD32;
            font-size: 30px;
            user-select: none;
            filter: drop-shadow(0 0 5px lime);
        }

        /* Hi·ªáu ·ª©ng n·ªï */
        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            pointer-events: none;
            user-select: none;
            animation: explode 0.5s forwards;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Hi·ªÉn th·ªã th√¥ng tin */
        #score, #high-score, #lives, #time-counter, #difficulty-indicator {
            position: absolute;
            font-weight: bold;
        }

        #score {
            top: 10px;
            right: 10px;
            font-size: 18px;
            color: #ff0066;
        }

        #high-score {
            top: 10px;
            left: 10px;
            font-size: 18px;
            color: #ff0066;
            transition: all 0.3s;
        }

        #lives {
            top: 40px;
            right: 10px;
            font-size: 16px;
            color: #00BFFF;
        }

        #time-counter {
            top: 40px;
            left: 10px;
            font-size: 16px;
            color: #32CD32;
        }

        #difficulty-indicator {
            top: 70px;
            right: 10px;
            font-size: 14px;
            color: #FFD700;
        }

        #pause-button {
            position: absolute;
            top: 70px;
            left: 10px;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        #pause-button:hover {
            background-color: white;
        }

        /* Start and Game Over Screens */
        h1 {
            color: #ff0066;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #ff0066;
            margin-bottom: 15px;
        }

        #final-score {
            font-size: 32px;
            color: #ff0066;
            margin-bottom: 10px;
        }

        #time-left {
            font-size: 18px;
            color: #32CD32;
            margin-bottom: 20px;
        }

        #player-name {
            padding: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: 60%;
            max-width: 250px;
        }

        #save-score-button, #restart-button, #back-to-menu-button, #resume-button, #quit-button, #start-button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #ff0066;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s, background-color 0.2s;
        }

        #save-score-button:hover, #restart-button:hover, #back-to-menu-button:hover, 
        #resume-button:hover, #quit-button:hover, #start-button:hover {
            background-color: #ff4d94;
            transform: scale(1.05);
        }

        /* H∆∞·ªõng d·∫´n */
        .item-info {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions {
            font-size: 14px;
            max-width: 400px;
            margin: 20px auto;
            text-align: left;
        }

        /* Hi·ªáu ·ª©ng ƒë·∫øm ng∆∞·ª£c */
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }

        .countdown-number {
            font-size: 100px;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Time warning animation */
        @keyframes timeWarning {
            0%, 100% { color: #32CD32; }
            50% { color: red; font-size: 18px; }
        }

        .time-warning {
            animation: timeWarning 0.5s infinite;
        }

        /* CSS cho nh√¢n v·∫≠t (h·ªá th·ªëng c≈©) */
        #dropper-character {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            z-index: 5;
            animation: float 3s ease-in-out infinite;
        }

        /* Hi·ªáu ·ª©ng n·ªïi l√™n xu·ªëng */
        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* CSS cho nh√¢n v·∫≠t h·ª©ng tim ·ªü d∆∞·ªõi */
        #catcher-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 100px;
            z-index: 5;
        }

        #catcher-character {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* T·∫°o hi·ªáu ·ª©ng khi b·∫Øt ƒë∆∞·ª£c tim */
        @keyframes catch {
            0% { transform: scaleY(1); }
            50% { transform: scaleY(0.9); }
            100% { transform: scaleY(1); }
        }

        .catching {
            animation: catch 0.3s ease-in-out;
        }

        /* Hi·ªáu ·ª©ng th·∫£ tim */
        @keyframes dropping {
            0% { transform: translateY(0); }
            50% { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }

        .dropping {
            animation: dropping 0.3s ease-in-out;
        }

        /* Hi·ªáu ·ª©ng l·∫Øc khi h·ª©ng miss tim */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .shaking {
            animation: shake 0.5s ease-in-out;
        }

        /* Hi·ªáu ·ª©ng nh·∫£y l√™n khi ƒë·∫°t m·ªëc ƒëi·ªÉm 10, 20, ... */
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .jumping {
            animation: jump 0.5s ease-in-out;
        }

        /* CSS cho h√¨nh ·∫£nh nh√¢n v·∫≠t */
        #dropper-character img, #catcher-character img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Responsive design */
        @media (max-width: 500px) {
            .menu-button {
                min-width: 150px;
                padding: 12px 20px;
                font-size: 18px;
            }
            
            #final-score {
                font-size: 28px;
            }
            
            .instructions {
                font-size: 12px;
            }
        }

        /* Hi·ªáu ·ª©ng √°nh s√°ng khi h·ª©ng ƒë∆∞·ª£c v·∫≠t ph·∫©m */
        .light-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.7) 0%, rgba(255,215,0,0) 70%);
            z-index: 4;
            pointer-events: none;
            animation: light-fade 0.5s ease-out forwards;
        }

        @keyframes light-fade {
            0% { opacity: 0.7; transform: scale(0.5); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        /* CSS cho h√¨nh ·∫£nh nh√¢n v·∫≠t khi bu·ªìn/m·ªát */
        .sad img {
            filter: grayscale(30%);
            transform: rotate(5deg);
        }

        .tired img {
            filter: grayscale(30%);
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Khu v·ª±c ch∆°i game -->
        <div id="game-area" style="display: none;">
            <div id="score">ƒêi·ªÉm: 0</div>
            <div id="high-score">Cao nh·∫•t: 0</div>
            <div id="lives">M·∫°ng: 3</div>
            <div id="time-counter">Th·ªùi gian: 60</div>
            <div id="difficulty-indicator">ƒê·ªô kh√≥: D·ªÖ</div>
            
            <!-- Nh√¢n v·∫≠t th·∫£ tim ·ªü tr√™n - S·ª≠ d·ª•ng h√¨nh ·∫£nh -->
            <div id="dropper-character">
                <img src="images/dropper.png" alt="Nh√¢n v·∫≠t th·∫£ tim">
            </div>
            
            <!-- Gi·ªè h·ª©ng (·∫©n nh∆∞ng v·∫´n gi·ªØ l·∫°i ƒë·ªÉ logic game kh√¥ng ƒë·ªïi) -->
            <div id="basket">üß∫</div>
            
            <!-- Nh√¢n v·∫≠t h·ª©ng tim ·ªü d∆∞·ªõi - S·ª≠ d·ª•ng h√¨nh ·∫£nh -->
            <div id="catcher-container">
                <div id="catcher-character">
                    <img src="images/catcher.png" alt="Nh√¢n v·∫≠t h·ª©ng tim">
                </div>
            </div>
            
            <div id="pause-button">
                <i class="fas fa-pause"></i>
            </div>
        </div>
        
        <!-- Menu ch√≠nh -->
        <div id="main-menu">
            <h1>Game H·ª©ng Tr√°i Tim</h1>
            <div class="menu-buttons">
                <button id="play-button" class="menu-button">Ch∆°i Game</button>
                <button id="settings-button" class="menu-button">C√†i ƒê·∫∑t</button>
                <button id="leaderboard-button" class="menu-button">B·∫£ng X·∫øp H·∫°ng</button>
            </div>
        </div>
        
        <!-- Menu ch·ªçn ƒë·ªô kh√≥ -->
        <div id="difficulty-menu" style="display: none;">
            <h2>Ch·ªçn ƒê·ªô Kh√≥</h2>
            <div class="menu-buttons">
                <button id="easy-button" class="menu-button">D·ªÖ</button>
                <button id="medium-button" class="menu-button">Trung B√¨nh</button>
                <button id="hard-button" class="menu-button">Kh√≥</button>
            </div>
            <button id="back-from-difficulty" class="back-button">
                <i class="fas fa-arrow-left"></i> Quay L·∫°i
            </button>
        </div>
        
        <!-- Menu c√†i ƒë·∫∑t √¢m l∆∞·ª£ng -->
        <div id="settings-menu" style="display: none;">
            <h2>C√†i ƒê·∫∑t</h2>
            <div class="setting-item">
                <label for="volume-slider">√Çm l∆∞·ª£ng game:</label>
                <input type="range" id="volume-slider" min="0" max="100" value="80">
                <span id="volume-value">80%</span>
            </div>
            <div class="setting-item">
                <label for="bgm-slider">Nh·∫°c n·ªÅn:</label>
                <input type="range" id="bgm-slider" min="0" max="100" value="50">
                <span id="bgm-value">50%</span>
            </div>
            <div class="setting-item">
                <label for="username-input">T√™n ng∆∞·ªùi ch∆°i:</label>
                <input type="text" id="username-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            </div>
            <button id="back-from-settings" class="back-button">
                <i class="fas fa-arrow-left"></i> Quay L·∫°i
            </button>
        </div>
        
        <!-- B·∫£ng x·∫øp h·∫°ng -->
        <div id="leaderboard-menu" style="display: none;">
            <h2>B·∫£ng X·∫øp H·∫°ng</h2>
            <div id="leaderboard-list">
                <!-- D·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o b·∫±ng JavaScript -->
            </div>
            <button id="back-from-leaderboard" class="back-button">
                <i class="fas fa-arrow-left"></i> Quay L·∫°i
            </button>
        </div>
        
        <!-- M√†n h√¨nh h∆∞·ªõng d·∫´n v√† b·∫Øt ƒë·∫ßu ch∆°i -->
        <div id="start-screen" style="display: none;">
            <h1>Game H·ª©ng Tr√°i Tim</h1>
            <p>Di chuy·ªÉn chu·ªôt ho·∫∑c ng√≥n tay ƒë·ªÉ ƒëi·ªÅu khi·ªÉn nh√¢n v·∫≠t h·ª©ng tim</p>
            
            <div class="instructions">
                <div class="item-info">
                    <span>‚ù§Ô∏è</span>
                    <span>Tr√°i tim th∆∞·ªùng - 1 ƒëi·ªÉm</span>
                </div>
                <div class="item-info">
                    <span>üíñ</span>
                    <span>Tr√°i tim ƒë·∫∑c bi·ªát - 5 ƒëi·ªÉm</span>
                </div>
                <div class="item-info">
                    <span>üíô</span>
                    <span>Th√™m 1 m·∫°ng</span>
                </div>
                <div class="item-info">
                    <span>‚è±Ô∏è</span>
                    <span>Th√™m th·ªùi gian</span>
                </div>
            </div>
            
            <button id="start-button">B·∫Øt ƒê·∫ßu Ch∆°i</button>
            <button id="back-from-instructions" class="back-button">
                <i class="fas fa-arrow-left"></i> Quay L·∫°i
            </button>
        </div>
        
        <!-- M√†n h√¨nh k·∫øt th√∫c game -->
        <div id="game-over" style="display: none;">
            <h1>Game Over!</h1>
            <div id="final-score">ƒêi·ªÉm: 0</div>
            <div id="time-left"></div>
            <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
            <button id="save-score-button">L∆∞u ƒêi·ªÉm</button>
            <button id="restart-button">Ch∆°i L·∫°i</button>
            <button id="back-to-menu-button">Tr·ªü V·ªÅ Menu</button>
        </div>
        
        <!-- M√†n h√¨nh t·∫°m d·ª´ng -->
        <div id="pause-screen" style="display: none;">
            <h2>T·∫°m D·ª´ng</h2>
            <button id="resume-button">Ti·∫øp T·ª•c</button>
            <button id="quit-button">Tho√°t Game</button>
        </div>
    </div>

    <!-- √Çm thanh game (ƒë∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c sounds) -->
    <audio id="catch-sound" src="sounds/catch.mp3" preload="auto"></audio>
    <audio id="miss-sound" src="sounds/miss.wav" preload="auto"></audio>
    <audio id="game-over-sound" src="sounds/game-over.wav" preload="auto"></audio>
    <audio id="special-sound" src="sounds/special.mp4" preload="auto"></audio>
    <audio id="life-sound" src="sounds/life.wav" preload="auto"></audio>
    <audio id="time-sound" src="sounds/time.mp3" preload="auto"></audio>
    <audio id="button-sound" src="sounds/button.mp3" preload="auto"></audio>
    <audio id="countdown-sound" src="sounds/countdown.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/background.mp3" preload="auto" loop></audio>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM content loaded");
            
            // Game DOM Elements
            const gameContainer = document.getElementById('game-container');
            const gameArea = document.getElementById('game-area');
            const basket = document.getElementById('basket');
            const scoreDisplay = document.getElementById('score');
            const highScoreDisplay = document.getElementById('high-score');
            const livesDisplay = document.getElementById('lives');
            const timeCounter = document.getElementById('time-counter');
            const difficultyIndicator = document.getElementById('difficulty-indicator');
            const pauseButton = document.getElementById('pause-button');

            // Nh√¢n v·∫≠t DOM Elements
            const dropperCharacter = document.getElementById('dropper-character');
            const catcherContainer = document.getElementById('catcher-container');
            const catcherCharacter = document.getElementById('catcher-character');

            // Menu DOM Elements
            const mainMenu = document.getElementById('main-menu');
            const playButton = document.getElementById('play-button');
            const settingsButton = document.getElementById('settings-button');
            const leaderboardButton = document.getElementById('leaderboard-button');

            // Difficulty Menu
            const difficultyMenu = document.getElementById('difficulty-menu');
            const easyButton = document.getElementById('easy-button');
            const mediumButton = document.getElementById('medium-button');
            const hardButton = document.getElementById('hard-button');
            const backFromDifficulty = document.getElementById('back-from-difficulty');

            // Settings Menu
            const settingsMenu = document.getElementById('settings-menu');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeValue = document.getElementById('volume-value');
            const bgmSlider = document.getElementById('bgm-slider');
            const bgmValue = document.getElementById('bgm-value');
            const usernameInput = document.getElementById('username-input');
            const backFromSettings = document.getElementById('back-from-settings');

            // Leaderboard Menu
            const leaderboardMenu = document.getElementById('leaderboard-menu');
            const leaderboardList = document.getElementById('leaderboard-list');
            const backFromLeaderboard = document.getElementById('back-from-leaderboard');

            // Game Screens
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const backFromInstructions = document.getElementById('back-from-instructions');
            const gameOverScreen = document.getElementById('game-over');
            const finalScore = document.getElementById('final-score');
            const timeLeft = document.getElementById('time-left');
            const playerNameInput = document.getElementById('player-name');
            const saveScoreButton = document.getElementById('save-score-button');
            const restartButton = document.getElementById('restart-button');
            const backToMenuButton = document.getElementById('back-to-menu-button');
            const pauseScreen = document.getElementById('pause-screen');
            const resumeButton = document.getElementById('resume-button');
            const quitButton = document.getElementById('quit-button');

            // Audio Elements
            const catchSound = document.getElementById('catch-sound');
            const missSound = document.getElementById('miss-sound');
            const gameOverSound = document.getElementById('game-over-sound');
            const specialSound = document.getElementById('special-sound');
            const lifeSound = document.getElementById('life-sound');
            const timeSound = document.getElementById('time-sound');
            const buttonSound = document.getElementById('button-sound');
            const countdownSound = document.getElementById('countdown-sound');
            const backgroundMusic = document.getElementById('background-music');

            // Game Settings
            let score = 0;
            let lives = 3;
            let timeRemaining = 60; 
            let gameSpeed = 1500; 
            let heartSpeed = 2; 
            let hearts = [];
            let gameInterval;
            let timeInterval;
            let isGameRunning = false;
            let isPaused = false;
            let selectedDifficulty = 'easy'; 
            let currentUsername = localStorage.getItem('username') || 'Player';

            // Difficulty settings
            const difficulties = {
                easy: {
                    initialTime: 60,
                    initialSpeed: 1500,
                    heartSpeed: 2,
                    livesCount: 3,
                    timeBonus: 10,
                    specialHeartChance: 0.15,
                    extraLifeChance: 0.05,
                    extraTimeChance: 0.05,
                    speedIncrement: 0.1
                },
                medium: {
                    initialTime: 45,
                    initialSpeed: 1200,
                    heartSpeed: 3,
                    livesCount: 2,
                    timeBonus: 8,
                    specialHeartChance: 0.12,
                    extraLifeChance: 0.04,
                    extraTimeChance: 0.04,
                    speedIncrement: 0.15
                },
                hard: {
                    initialTime: 30,
                    initialSpeed: 1000,
                    heartSpeed: 4,
                    livesCount: 1,
                    timeBonus: 5,
                    specialHeartChance: 0.1,
                    extraLifeChance: 0.03,
                    extraTimeChance: 0.03,
                    speedIncrement: 0.2
                }
            };

            // √Çm l∆∞·ª£ng
            let volumeLevel = localStorage.getItem('volume') || 80;
            let bgmLevel = localStorage.getItem('bgm') || 50;

            // Thi·∫øt l·∫≠p ƒëi·ªÉm cao nh·∫•t t·ª´ localStorage
            let highScore = localStorage.getItem('heartGameHighScore') || 0;
            highScoreDisplay.textContent = 'Cao nh·∫•t: ' + highScore;

            // Kh·ªüi t·∫°o b·∫£ng x·∫øp h·∫°ng
            let leaderboard = JSON.parse(localStorage.getItem('heartGameLeaderboard')) || [];

            // Set basket initial position
            const initialX = gameContainer.clientWidth / 2;
            basket.style.left = initialX + 'px';
            catcherContainer.style.left = initialX + 'px';

            // ƒêƒÉng k√Ω t·∫•t c·∫£ s·ª± ki·ªán
            setupEvents();

            // Kh·ªüi t·∫°o game
            initializeSettings();

            // FUNCTIONS
            
            // C√†i ƒë·∫∑t c√°c s·ª± ki·ªán
            function setupEvents() {
                // Menu ch√≠nh
                playButton.addEventListener('click', function() {
                    console.log("Play button clicked");
                    playButtonSound();
                    showScreen(difficultyMenu);
                    hideScreen(mainMenu);
                });

                settingsButton.addEventListener('click', function() {
                    playButtonSound();
                    showScreen(settingsMenu);
                    hideScreen(mainMenu);
                });

                leaderboardButton.addEventListener('click', function() {
                    playButtonSound();
                    updateLeaderboardDisplay();
                    showScreen(leaderboardMenu);
                    hideScreen(mainMenu);
                });

                // ƒê·ªô kh√≥
                easyButton.addEventListener('click', function() {
                    playButtonSound();
                    selectedDifficulty = 'easy';
                    difficultyIndicator.textContent = 'ƒê·ªô kh√≥: D·ªÖ';
                    showScreen(startScreen);
                    hideScreen(difficultyMenu);
                });

                mediumButton.addEventListener('click', function() {
                    playButtonSound();
                    selectedDifficulty = 'medium';
                    difficultyIndicator.textContent = 'ƒê·ªô kh√≥: Trung B√¨nh';
                    showScreen(startScreen);
                    hideScreen(difficultyMenu);
                });

                hardButton.addEventListener('click', function() {
                    playButtonSound();
                    selectedDifficulty = 'hard';
                    difficultyIndicator.textContent = 'ƒê·ªô kh√≥: Kh√≥';
                    showScreen(startScreen);
                    hideScreen(difficultyMenu);
                });

                backFromDifficulty.addEventListener('click', function() {
                    playButtonSound();
                    showScreen(mainMenu);
                    hideScreen(difficultyMenu);
                });

                // C√†i ƒë·∫∑t
                volumeSlider.addEventListener('input', function() {
                    volumeLevel = volumeSlider.value;
                    volumeValue.textContent = volumeLevel + '%';
                    updateVolume();
                    localStorage.setItem('volume', volumeLevel);
                });

                bgmSlider.addEventListener('input', function() {
                    bgmLevel = bgmSlider.value;
                    bgmValue.textContent = bgmLevel + '%';
                    updateBGMVolume();
                    localStorage.setItem('bgm', bgmLevel);
                });

                usernameInput.addEventListener('change', function() {
                    currentUsername = usernameInput.value.trim() || 'Player';
                    localStorage.setItem('username', currentUsername);
                });

                backFromSettings.addEventListener('click', function() {
                    playButtonSound();
                    showScreen(mainMenu);
                    hideScreen(settingsMenu);
                });

                // B·∫£ng x·∫øp h·∫°ng
                backFromLeaderboard.addEventListener('click', function() {
                    playButtonSound();
                    showScreen(mainMenu);
                    hideScreen(leaderboardMenu);
                });

                // C√°c m√†n h√¨nh game
                startButton.addEventListener('click', function() {
                    playButtonSound();
                    hideScreen(startScreen);
                    showScreen(gameArea);
                    startCountdown();
                });

                backFromInstructions.addEventListener('click', function() {
                    playButtonSound();
                    showScreen(difficultyMenu);
                    hideScreen(startScreen);
                });

                restartButton.addEventListener('click', function() {
                    playButtonSound();
                    hideScreen(gameOverScreen);
                    startCountdown();
                });

                backToMenuButton.addEventListener('click', function() {
                    playButtonSound();
                    hideScreen(gameOverScreen);
                    showScreen(mainMenu);
                });

                // T·∫°m d·ª´ng
                pauseButton.addEventListener('click', function() {
                    playButtonSound();
                    pauseGame();
                });

                resumeButton.addEventListener('click', function() {
                    playButtonSound();
                    resumeGame();
                });

                quitButton.addEventListener('click', function() {
                    playButtonSound();
                    endGame(true);
                    hideScreen(pauseScreen);
                    showScreen(mainMenu);
                });

                // L∆∞u ƒëi·ªÉm
                saveScoreButton.addEventListener('click', function() {
                    playButtonSound();
                    const playerName = playerNameInput.value.trim() || currentUsername;
                    saveScore(playerName, score);
                    saveScoreButton.disabled = true;
                    saveScoreButton.textContent = "ƒê√£ L∆∞u!";
                });

                // Th√™m event listener cho chu·ªôt/ch·∫°m
                gameContainer.addEventListener('mousemove', moveBasket);
                gameContainer.addEventListener('touchmove', moveBasket, { passive: false });

                // Handle touch devices better
                document.addEventListener('touchmove', function(e) {
                    if (isGameRunning) {
                        e.preventDefault();
                    }
                }, { passive: false });

                // X·ª≠ l√Ω ph√≠m ·∫•n ƒë·ªÉ debug/t·∫°m d·ª´ng
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isGameRunning) {
                        if (isPaused) {
                            resumeGame();
                        } else {
                            pauseGame();
                        }
                    }
                    
                    // Th√™m ph√≠m 'd' ƒë·ªÉ debug - t·∫°o v·∫≠t ph·∫©m khi nh·∫•n
                    if (e.key === 'd' && isGameRunning) {
                        console.log("Debug: T·∫°o v·∫≠t ph·∫©m m·ªõi");
                        createRandomItem();
                    }
                });
            }

            // Kh·ªüi t·∫°o c√†i ƒë·∫∑t
            function initializeSettings() {
                // Set volume sliders
                volumeSlider.value = volumeLevel;
                volumeValue.textContent = volumeLevel + '%';
                bgmSlider.value = bgmLevel;
                bgmValue.textContent = bgmLevel + '%';
                
                // Set username
                usernameInput.value = currentUsername;
                playerNameInput.value = currentUsername;
                
                // Update audio volumes
                updateVolume();
                updateBGMVolume();
                
                // NgƒÉn ch·∫∑n l·ªói √¢m thanh
                const audioElements = [catchSound, missSound, gameOverSound, specialSound, lifeSound, timeSound, buttonSound, countdownSound, backgroundMusic];
                audioElements.forEach(audio => {
                    if (audio) {
                        audio.onerror = () => {
                            console.log(`Kh√¥ng th·ªÉ t·∫£i file √¢m thanh: ${audio.src}`);
                            audio.errorHandled = true;
                        };
                    }
                });
            }

            // C·∫≠p nh·∫≠t √¢m l∆∞·ª£ng
            function updateVolume() {
                const volume = volumeLevel / 100;
                if (catchSound) catchSound.volume = volume;
                if (missSound) missSound.volume = volume;
                if (gameOverSound) gameOverSound.volume = volume;
                if (specialSound) specialSound.volume = volume;
                if (lifeSound) lifeSound.volume = volume;
                if (timeSound) timeSound.volume = volume;
                if (buttonSound) buttonSound.volume = volume;
                if (countdownSound) countdownSound.volume = volume;
            }

            // C·∫≠p nh·∫≠t √¢m l∆∞·ª£ng nh·∫°c n·ªÅn
            function updateBGMVolume() {
                if (backgroundMusic) backgroundMusic.volume = bgmLevel / 100;
            }

            // Ph√°t √¢m thanh
            function playSound(sound) {
                if (!sound || sound.errorHandled) return;
                
                try {
                    sound.currentTime = 0;
                    sound.play().catch(error => {
                        console.log("L·ªói ph√°t √¢m thanh:", error);
                        sound.errorHandled = true;
                    });
                } catch (e) {
                    console.log("L·ªói ph√°t √¢m thanh:", e);
                    sound.errorHandled = true;
                }
            }

            // Ph√°t √¢m thanh n√∫t
            function playButtonSound() {
                try {
                    if (buttonSound && buttonSound.readyState >= 2 && !buttonSound.errorHandled) {
                        buttonSound.currentTime = 0;
                        buttonSound.play().catch(e => {
                            console.log("L·ªói ph√°t √¢m thanh n√∫t:", e);
                            buttonSound.errorHandled = true;
                        });
                    }
                } catch (error) {
                    console.log("B·ªè qua l·ªói √¢m thanh n√∫t");
                }
            }

            // Hi·ªÉn th·ªã/·∫©n m√†n h√¨nh
            function showScreen(element) {
                if (element) element.style.display = 'flex';
            }

            function hideScreen(element) {
                if (element) element.style.display = 'none';
            }

            // Di chuy·ªÉn gi·ªè theo chu·ªôt/ch·∫°m
            function moveBasket(e) {
                if (!isGameRunning || isPaused) return;
                
                let posX;
                
                // Ki·ªÉm tra lo·∫°i s·ª± ki·ªán
                if (e.type === 'touchmove') {
                    // NgƒÉn cu·ªôn trang
                    e.preventDefault();
                    // L·∫•y v·ªã tr√≠ ch·∫°m t∆∞∆°ng ƒë·ªëi v·ªõi container
                    const touch = e.touches[0];
                    const rect = gameContainer.getBoundingClientRect();
                    posX = touch.clientX - rect.left;
                } else {
                    // L·∫•y v·ªã tr√≠ chu·ªôt t∆∞∆°ng ƒë·ªëi v·ªõi container
                    const rect = gameContainer.getBoundingClientRect();
                    posX = e.clientX - rect.left;
                }
                
                // Gi·ªØ gi·ªè v√† nh√¢n v·∫≠t h·ª©ng trong gi·ªõi h·∫°n container
                if (posX < 40) posX = 40;
                if (posX > gameContainer.clientWidth - 40) posX = gameContainer.clientWidth - 40;
                
                // Di chuy·ªÉn c·∫£ gi·ªè v√† nh√¢n v·∫≠t h·ª©ng
                basket.style.left = posX + 'px';
                catcherContainer.style.left = posX + 'px';
            }

            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            function startCountdown() {
                console.log("Starting countdown");
                // Thi·∫øt l·∫≠p l·∫°i game theo ƒë·ªô kh√≥ ƒë√£ ch·ªçn
                const difficulty = difficulties[selectedDifficulty];
                
                lives = difficulty.livesCount;
                timeRemaining = difficulty.initialTime;
                gameSpeed = difficulty.initialSpeed;
                heartSpeed = difficulty.heartSpeed;
                
                score = 0;
                scoreDisplay.textContent = 'ƒêi·ªÉm: ' + score;
                livesDisplay.textContent = 'M·∫°ng: ' + lives;
                timeCounter.textContent = 'Th·ªùi gian: ' + timeRemaining;
                
                // Reset save button
                saveScoreButton.disabled = false;
                saveScoreButton.textContent = "L∆∞u ƒêi·ªÉm";
                
                // ƒê·∫£m b·∫£o nh√¢n v·∫≠t c√≥ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
                dropperCharacter.classList.remove('sad');
                catcherCharacter.classList.remove('tired');
                catcherContainer.classList.remove('shaking');
                
                // T·∫°o hi·ªáu ·ª©ng ƒë·∫øm ng∆∞·ª£c
                const countdownOverlay = document.createElement('div');
                countdownOverlay.className = 'countdown-overlay';
                
                const countdownNumber = document.createElement('div');
                countdownNumber.className = 'countdown-number';
                countdownOverlay.appendChild(countdownNumber);
                
                gameContainer.appendChild(countdownOverlay);
                
                // ƒê·∫øm ng∆∞·ª£c 3, 2, 1
                let count = 3;
                countdownNumber.textContent = count;
                playSound(countdownSound);
                
                const countInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownNumber.textContent = count;
                        playSound(countdownSound);
                    } else {
                        clearInterval(countInterval);
                        gameContainer.removeChild(countdownOverlay);
                        startGame();
                    }
                }, 1000);
            }

            // B·∫Øt ƒë·∫ßu game
            function startGame() {
                console.log("Starting game");
                showScreen(gameArea);
                
                // X√≥a t·∫•t c·∫£ tr√°i tim hi·ªán c√≥
                hearts.forEach(heart => {
                    if (heart.element.parentNode) {
                        gameContainer.removeChild(heart.element);
                    }
                });
                hearts = [];
                
                // X√≥a interval hi·ªán c√≥
                clearInterval(gameInterval);
                clearInterval(timeInterval);
                
                // ƒê·∫∑t l·∫°i m√†u n·ªÅn
                gameContainer.style.backgroundColor = '#ffeaf0';
                
                // Di chuy·ªÉn nh√¢n v·∫≠t th·∫£ tim ƒë·∫øn v·ªã tr√≠ ng·∫´u nhi√™n ban ƒë·∫ßu
                moveDropperToRandomPosition();
                
                // ƒê·∫£m b·∫£o nh√¢n v·∫≠t h·ª©ng ·ªü v·ªã tr√≠ ƒë√∫ng
                catcherContainer.style.left = initialX + 'px';
                basket.style.left = initialX + 'px';
                
                // Ph√°t nh·∫°c n·ªÅn
                if (backgroundMusic) {
                    backgroundMusic.play().catch(error => {
                        console.log("Kh√¥ng th·ªÉ ph√°t nh·∫°c n·ªÅn:", error);
                    });
                }
                
                // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p tr√≤ ch∆°i
                isGameRunning = true;
                isPaused = false;
                gameInterval = setInterval(createRandomItem, gameSpeed);
                startTimeCounter();
                startRandomBlinking();
                requestAnimationFrame(gameLoop);
            }

            // ƒê·∫øm th·ªùi gian
            function startTimeCounter() {
                timeInterval = setInterval(() => {
                    timeRemaining--;
                    timeCounter.textContent = 'Th·ªùi gian: ' + timeRemaining;
                    
                    // C·∫£nh b√°o khi th·ªùi gian s·∫Øp h·∫øt
                    if (timeRemaining <= 10) {
                        timeCounter.classList.add('time-warning');
                    } else {
                        timeCounter.classList.remove('time-warning');
                    }
                    
                    if (timeRemaining <= 0) {
                        endGame(false);
                    }
                }, 1000);
            }

            // V√≤ng l·∫∑p tr√≤ ch∆°i
            function gameLoop() {
                if (!isGameRunning || isPaused) return;
                
                moveHearts();
                requestAnimationFrame(gameLoop);
            }

            // T·∫°m d·ª´ng game
            function pauseGame() {
                if (!isGameRunning || isPaused) return;
                
                isPaused = true;
                clearInterval(gameInterval);
                clearInterval(timeInterval);
                if (backgroundMusic) backgroundMusic.pause();
                showScreen(pauseScreen);
            }

            // Ti·∫øp t·ª•c game
            function resumeGame() {
                if (!isGameRunning || !isPaused) return;
                
                isPaused = false;
                gameInterval = setInterval(createRandomItem, gameSpeed);
                startTimeCounter();
                if (backgroundMusic) {
                    backgroundMusic.play().catch(error => {
                        console.log("Kh√¥ng th·ªÉ ph√°t nh·∫°c n·ªÅn:", error);
                    });
                }
                hideScreen(pauseScreen);
                requestAnimationFrame(gameLoop);
            }

            // K·∫øt th√∫c tr√≤ ch∆°i
            function endGame(isQuit) {
                console.log("Ending game, quit:", isQuit);
                isGameRunning = false;
                isPaused = false;
                clearInterval(gameInterval);
                clearInterval(timeInterval);
                
                // D·ª´ng nh·∫°c n·ªÅn
                if (backgroundMusic) {
                    backgroundMusic.pause();
                    backgroundMusic.currentTime = 0;
                }
                
                if (!isQuit) {
                    // Th√™m tr·∫°ng th√°i bu·ªìn cho nh√¢n v·∫≠t th·∫£ tim
                    dropperCharacter.classList.add('sad');
                    
                    // Ph√°t √¢m thanh k·∫øt th√∫c game
                    playSound(gameOverSound);
                    
                    // C·∫≠p nh·∫≠t ƒëi·ªÉm cao nh·∫•t
                    const isNewHighScore = updateHighScore();
                    
                    // Hi·ªÉn th·ªã m√†n h√¨nh k·∫øt th√∫c
                    finalScore.textContent = 'ƒêi·ªÉm: ' + score;
                    if (timeRemaining > 0) {
                        timeLeft.textContent = 'Th·ªùi gian c√≤n: ' + timeRemaining + 's';
                    } else {
                        timeLeft.textContent = 'H·∫øt th·ªùi gian!';
                    }
                    
                    // N·∫øu l√† ƒëi·ªÉm cao m·ªõi, n·ªïi b·∫≠t th√¥ng b√°o
                    if (isNewHighScore) {
                        const newRecordMsg = document.createElement('div');
                        newRecordMsg.textContent = 'üèÜ K·ª∂ L·ª§C M·ªöI! üèÜ';
                        newRecordMsg.style.color = '#FFD700';
                        newRecordMsg.style.fontSize = '24px';
                        newRecordMsg.style.fontWeight = 'bold';
                        newRecordMsg.style.marginBottom = '10px';
                        
                        // Ch√®n th√¥ng b√°o v√†o tr∆∞·ªõc final score
                        gameOverScreen.insertBefore(newRecordMsg, finalScore);
                        
                        // X√≥a th√¥ng b√°o sau khi ng∆∞·ªùi ch∆°i ƒë√≥ng m√†n h√¨nh
                        const removeNewRecordMsg = () => {
                            if (newRecordMsg.parentNode) {
                                gameOverScreen.removeChild(newRecordMsg);
                            }
                            restartButton.removeEventListener('click', removeNewRecordMsg);
                            backToMenuButton.removeEventListener('click', removeNewRecordMsg);
                        };
                        
                        restartButton.addEventListener('click', removeNewRecordMsg);
                        backToMenuButton.addEventListener('click', removeNewRecordMsg);
                    }
                    
                    showScreen(gameOverScreen);
                }
                
                // X√≥a t·∫•t c·∫£ tr√°i tim hi·ªán c√≥
                hearts.forEach(heart => {
                    if (heart.element.parentNode) {
                        gameContainer.removeChild(heart.element);
                    }
                });
                hearts = [];
            }

            // C·∫≠p nh·∫≠t ƒëi·ªÉm cao nh·∫•t
            function updateHighScore() {
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('heartGameHighScore', highScore);
                    highScoreDisplay.textContent = 'Cao nh·∫•t: ' + highScore;
                    
                    // Hi·ªáu ·ª©ng khi ƒë·∫°t ƒëi·ªÉm cao m·ªõi
                    highScoreDisplay.style.fontSize = '24px';
                    highScoreDisplay.style.color = '#FFD700';
                    setTimeout(() => {
                        highScoreDisplay.style.fontSize = '18px';
                        highScoreDisplay.style.color = '#ff0066';
                    }, 1000);
                    
                    return true;
                }
                return false;
            }

            // T·∫°o hi·ªáu ·ª©ng n·ªï
            function createExplosion(x, y) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = (x - 40) + 'px';
                explosion.style.top = (y - 40) + 'px';
                
                // Th√™m emoji n·ªï
                explosion.innerHTML = '‚ú®';
                explosion.style.fontSize = '40px';
                
                gameContainer.appendChild(explosion);
                
                // X√≥a hi·ªáu ·ª©ng sau khi ho√†n th√†nh
                setTimeout(() => {
                    if (explosion.parentNode) {
                        gameContainer.removeChild(explosion);
                    }
                }, 500);
            }

            // T·∫°o hi·ªáu ·ª©ng √°nh s√°ng khi h·ª©ng ƒë∆∞·ª£c v·∫≠t ph·∫©m
            function createLightEffect(x, y) {
                const light = document.createElement('div');
                light.className = 'light-effect';
                light.style.left = (x - 50) + 'px';
                light.style.top = (y - 50) + 'px';
                
                gameContainer.appendChild(light);
                
                // X√≥a hi·ªáu ·ª©ng sau khi ho√†n th√†nh
                setTimeout(() => {
                    if (light.parentNode) {
                        gameContainer.removeChild(light);
                    }
                }, 500);
            }

            // Thay ƒë·ªïi m√†u n·ªÅn theo ƒëi·ªÉm s·ªë
            function updateBackgroundColor() {
                // T·∫°o m√†u t·ª´ ƒëi·ªÉm s·ªë
                const hue = (score * 5) % 360; // ƒê·ªïi m√†u m·ªói 20 ƒëi·ªÉm
                gameContainer.style.backgroundColor = `hsl(${hue}, 100%, 95%)`;
            }

            // Th√™m hi·ªáu ·ª©ng khi nh√¢n v·∫≠t h·ª©ng ƒë∆∞·ª£c tim
            function addCatchingAnimation() {
                catcherCharacter.classList.add('catching');
                setTimeout(() => {
                    catcherCharacter.classList.remove('catching');
                }, 300);
            }

            // Th√™m hi·ªáu ·ª©ng m·ªát m·ªèi khi m·∫•t m·∫°ng
            function addTiredEffect() {
                catcherCharacter.classList.add('tired');
                setTimeout(() => {
                    catcherCharacter.classList.remove('tired');
                }, 800);
            }

            // Th√™m hi·ªáu ·ª©ng l·∫Øc khi b·ªè l·ª° tim
            function addShakingEffect() {
                catcherContainer.classList.add('shaking');
                setTimeout(() => {
                    catcherContainer.classList.remove('shaking');
                }, 500);
            }

            // Th√™m hi·ªáu ·ª©ng nh·∫£y l√™n khi ƒë·∫°t ƒëi·ªÉm cao
            function addJumpingEffect() {
                catcherCharacter.classList.add('jumping');
                setTimeout(() => {
                    catcherCharacter.classList.remove('jumping');
                }, 500);
            }

            // T·∫°o v·∫≠t ph·∫©m r∆°i ng·∫´u nhi√™n
            function createRandomItem() {
                const random = Math.random();
                const difficulty = difficulties[selectedDifficulty];
                
                // L·∫•y v·ªã tr√≠ c·ªßa nh√¢n v·∫≠t th·∫£ tim
                const dropperRect = dropperCharacter.getBoundingClientRect();
                const gameContainerRect = gameContainer.getBoundingClientRect();
                const dropperX = dropperRect.left + dropperRect.width/2 - gameContainerRect.left;
                
                // Th√™m hi·ªáu ·ª©ng nh√∫n nh·∫£y khi th·∫£ tim
                dropperCharacter.classList.add('dropping');
                setTimeout(() => {
                    dropperCharacter.classList.remove('dropping');
                }, 300);
                
                // Quy·∫øt ƒë·ªãnh lo·∫°i v·∫≠t ph·∫©m s·∫Ω t·∫°o
                if (random < difficulty.extraTimeChance) {
                    // T·∫°o v·∫≠t ph·∫©m th√™m th·ªùi gian
                    createExtraTime(dropperX);
                } else if (random < difficulty.extraTimeChance + difficulty.extraLifeChance) {
                    // T·∫°o v·∫≠t ph·∫©m th√™m m·∫°ng
                    createExtraLife(dropperX);
                } else if (random < difficulty.extraTimeChance + difficulty.extraLifeChance + difficulty.specialHeartChance) {
                    // T·∫°o tr√°i tim ƒë·∫∑c bi·ªát
                    createSpecialHeart(dropperX);
                } else {
                    // T·∫°o tr√°i tim th∆∞·ªùng
                    createNormalHeart(dropperX);
                }
                
                // Di chuy·ªÉn nh√¢n v·∫≠t th·∫£ tim ƒë·∫øn v·ªã tr√≠ ng·∫´u nhi√™n
                moveDropperToRandomPosition();
            }

            // Di chuy·ªÉn nh√¢n v·∫≠t th·∫£ tim ƒë·∫øn v·ªã tr√≠ ng·∫´u nhi√™n
            function moveDropperToRandomPosition() {
                const minX = 50;
                const maxX = gameContainer.clientWidth - 50;
                const randomX = Math.random() * (maxX - minX) + minX;
                
                // T·∫°o hi·ªáu ·ª©ng m∆∞·ª£t m√† khi di chuy·ªÉn
                dropperCharacter.style.transition = 'left 0.5s ease-out';
                dropperCharacter.style.left = randomX + 'px';
            }

            // Th√™m hi·ªáu ·ª©ng ch·ªõp m·∫Øt ng·∫´u nhi√™n cho nh√¢n v·∫≠t th·∫£ tim
            function startRandomBlinking() {
                const blinkInterval = setInterval(() => {
                    if (!isGameRunning) {
                        clearInterval(blinkInterval);
                        return;
                    }
                    
                    const shouldBlink = Math.random() > 0.7;
                    if (shouldBlink && !dropperCharacter.classList.contains('dropping')) {
                        const imgElement = dropperCharacter.querySelector('img');
                        if (imgElement) {
                            imgElement.style.opacity = '0.5';
                            setTimeout(() => {
                                imgElement.style.opacity = '1';
                            }, 200);
                        }
                    }
                }, 2000);
            }

            // T·∫°o tr√°i tim th∆∞·ªùng
            function createNormalHeart(posX = null) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = '‚ù§Ô∏è';
                
                // V·ªã tr√≠ ng·∫´u nhi√™n ho·∫∑c t·ª´ v·ªã tr√≠ dropperX
                const heartX = posX !== null ? posX : Math.random() * (gameContainer.clientWidth - 30);
                heart.style.left = heartX + 'px';
                
                // Th√™m v√†o game
                gameContainer.appendChild(heart);
                hearts.push({
                    element: heart,
                    posX: heartX,
                    posY: 80, // B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi nh√¢n v·∫≠t th·∫£ tim
                    type: 'normal',
                    points: 1
                });
            }

            // T·∫°o tr√°i tim ƒë·∫∑c bi·ªát
            function createSpecialHeart(posX = null) {
                const heart = document.createElement('div');
                heart.className = 'special-heart';
                heart.innerHTML = 'üíñ';
                
                const heartX = posX !== null ? posX : Math.random() * (gameContainer.clientWidth - 30);
                heart.style.left = heartX + 'px';
                
                gameContainer.appendChild(heart);
                hearts.push({
                    element: heart,
                    posX: heartX,
                    posY: 80,
                    type: 'special',
                    points: 5
                });
            }

            // T·∫°o v·∫≠t ph·∫©m th√™m m·∫°ng
            function createExtraLife(posX = null) {
                const heart = document.createElement('div');
                heart.className = 'extra-life';
                heart.innerHTML = 'üíô';
                
                const heartX = posX !== null ? posX : Math.random() * (gameContainer.clientWidth - 30);
                heart.style.left = heartX + 'px';
                
                gameContainer.appendChild(heart);
                hearts.push({
                    element: heart,
                    posX: heartX,
                    posY: 80,
                    type: 'life',
                    points: 0
                });
            }

            // T·∫°o v·∫≠t ph·∫©m th√™m th·ªùi gian
            function createExtraTime(posX = null) {
                const heart = document.createElement('div');
                heart.className = 'extra-time';
                heart.innerHTML = '‚è±Ô∏è';
                
                const heartX = posX !== null ? posX : Math.random() * (gameContainer.clientWidth - 30);
                heart.style.left = heartX + 'px';
                
                gameContainer.appendChild(heart);
                hearts.push({
                    element: heart,
                    posX: heartX,
                    posY: 80,
                    type: 'time',
                    points: 0
                });
            }

            // Di chuy·ªÉn tr√°i tim xu·ªëng
            function moveHearts() {
                // TƒÉng ƒë·ªô kh√≥ theo th·ªùi gian
                if (score > 0 && score % 10 === 0 && score % 20 !== 10) {
                    const difficulty = difficulties[selectedDifficulty];
                    heartSpeed += difficulty.speedIncrement;
                    
                    // Gi·ªõi h·∫°n t·ªëc ƒë·ªô t·ªëi ƒëa
                    const maxSpeed = difficulty.heartSpeed * 2.5;
                    if (heartSpeed > maxSpeed) {
                        heartSpeed = maxSpeed;
                    }
                    
                    // ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô t·∫°o item
                    gameSpeed = Math.max(800, gameSpeed - 50);
                    clearInterval(gameInterval);
                    gameInterval = setInterval(createRandomItem, gameSpeed);
                }
                
                // Di chuy·ªÉn t·ª´ng tr√°i tim
                for (let i = 0; i < hearts.length; i++) {
                    const heart = hearts[i];
                    heart.posY += heartSpeed;
                    heart.element.style.top = heart.posY + 'px';
                    
                    // Ki·ªÉm tra va ch·∫°m
                    if (heart.posY > gameContainer.clientHeight - 100 && 
                        heart.posY < gameContainer.clientHeight - 20) {
                        const basketLeft = parseInt(basket.style.left) - 40;
                        const basketRight = basketLeft + 80;
                        
                        if (heart.posX > basketLeft && heart.posX < basketRight) {
                            // H·ª©ng ƒë∆∞·ª£c v·∫≠t ph·∫©m
                            const heartX = heart.posX;
                            const heartY = heart.posY;
                            gameContainer.removeChild(heart.element);
                            hearts.splice(i, 1);
                            i--;
                            
                            // Th√™m hi·ªáu ·ª©ng h·ª©ng cho nh√¢n v·∫≠t
                            addCatchingAnimation();
                            
                            // X·ª≠ l√Ω theo lo·∫°i v·∫≠t ph·∫©m
                            if (heart.type === 'normal') {
                                score += heart.points;
                                scoreDisplay.textContent = 'ƒêi·ªÉm: ' + score;
                                playSound(catchSound);
                                createExplosion(heartX, heartY);
                                createLightEffect(heartX, heartY);
                                
                                // Th√™m hi·ªáu ·ª©ng nh·∫£y khi ƒë·∫°t m·ªëc ƒëi·ªÉm
                                if (score % 10 === 0) {
                                    addJumpingEffect();
                                }
                            } else if (heart.type === 'special') {
                                score += heart.points;
                                scoreDisplay.textContent = 'ƒêi·ªÉm: ' + score;
                                playSound(specialSound);
                                createExplosion(heartX, heartY);
                                createExplosion(heartX - 20, heartY - 20);
                                createExplosion(heartX + 20, heartY - 20);
                                createLightEffect(heartX, heartY);
                            } else if (heart.type === 'life') {
                                lives++;
                                livesDisplay.textContent = 'M·∫°ng: ' + lives;
                                playSound(lifeSound);
                                createExplosion(heartX, heartY);
                                createLightEffect(heartX, heartY);
                            } else if (heart.type === 'time') {
                                // Th√™m th·ªùi gian theo ƒë·ªô kh√≥
                                const difficulty = difficulties[selectedDifficulty];
                                timeRemaining += difficulty.timeBonus;
                                timeCounter.textContent = 'Th·ªùi gian: ' + timeRemaining;
                                playSound(timeSound);
                                createExplosion(heartX, heartY);
                                createLightEffect(heartX, heartY);
                            }
                            
                            updateBackgroundColor();
                        }
                    }
                    
                    // Ki·ªÉm tra n·∫øu v·∫≠t ph·∫©m b·ªã b·ªè l·ª°
                    if (heart.posY > gameContainer.clientHeight) {
                        gameContainer.removeChild(heart.element);
                        hearts.splice(i, 1);
                        i--;
                        
                        // Ch·ªâ m·∫•t m·∫°ng khi b·ªè l·ª° tr√°i tim th∆∞·ªùng ho·∫∑c ƒë·∫∑c bi·ªát
                        if (heart.type === 'normal' || heart.type === 'special') {
                            lives--;
                            livesDisplay.textContent = 'M·∫°ng: ' + lives;
                            playSound(missSound);
                            
                            // Th√™m hi·ªáu ·ª©ng l·∫Øc v√† m·ªát m·ªèi
                            addShakingEffect();
                            addTiredEffect();
                            
                            if (lives <= 0) {
                                endGame(false);
                            }
                        }
                    }
                }
            }

            // L∆∞u ƒëi·ªÉm v√†o b·∫£ng x·∫øp h·∫°ng
            function saveScore(playerName, playerScore) {
                // T·∫°o m·ªôt b·∫£n ghi m·ªõi
                const newRecord = {
                    name: playerName,
                    score: playerScore,
                    difficulty: selectedDifficulty,
                    date: new Date().toLocaleDateString()
                };
                
                // Th√™m v√†o b·∫£ng x·∫øp h·∫°ng
                leaderboard.push(newRecord);
                
                // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë gi·∫£m d·∫ßn
                leaderboard.sort((a, b) => b.score - a.score);
                
                // Gi·ªØ t·ªëi ƒëa 10 b·∫£n ghi
                if (leaderboard.length > 10) {
                    leaderboard = leaderboard.slice(0, 10);
                }
                
                // L∆∞u v√†o localStorage
                localStorage.setItem('heartGameLeaderboard', JSON.stringify(leaderboard));
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
                updateLeaderboardDisplay();
            }

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
            function updateLeaderboardDisplay() {
                // X√≥a c√°c ph·∫ßn t·ª≠ c≈©
                leaderboardList.innerHTML = '';
                
                // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                if (leaderboard.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'leaderboard-item';
                    emptyMsg.textContent = 'Ch∆∞a c√≥ ƒëi·ªÉm n√†o ƒë∆∞·ª£c l∆∞u!';
                    emptyMsg.style.justifyContent = 'center';
                    leaderboardList.appendChild(emptyMsg);
                    return;
                }
                
                // T·∫°o ti√™u ƒë·ªÅ
                const header = document.createElement('div');
                header.className = 'leaderboard-item';
                header.style.fontWeight = 'bold';
                header.style.backgroundColor = '#ff0066';
                header.style.color = 'white';
                
                const rankHeader = document.createElement('div');
                rankHeader.className = 'leaderboard-rank';
                rankHeader.textContent = '#';
                
                const nameHeader = document.createElement('div');
                nameHeader.className = 'leaderboard-name';
                nameHeader.textContent = 'T√™n';
                
                const scoreHeader = document.createElement('div');
                scoreHeader.className = 'leaderboard-score';
                scoreHeader.textContent = 'ƒêi·ªÉm';
                
                const difficultyHeader = document.createElement('div');
                difficultyHeader.textContent = 'ƒê·ªô kh√≥';
                difficultyHeader.style.marginRight = '10px';
                
                header.appendChild(rankHeader);
                header.appendChild(nameHeader);
                header.appendChild(scoreHeader);
                header.appendChild(difficultyHeader);
                
                leaderboardList.appendChild(header);
                
                // Th√™m t·ª´ng b·∫£n ghi
                leaderboard.forEach((record, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    const rank = document.createElement('div');
                    rank.className = 'leaderboard-rank';
                    rank.textContent = (index + 1);
                    
                    const name = document.createElement('div');
                    name.className = 'leaderboard-name';
                    name.textContent = record.name;
                    
                    const score = document.createElement('div');
                    score.className = 'leaderboard-score';
                    score.textContent = record.score;
                    
                    const difficulty = document.createElement('div');
                    
                    // Hi·ªÉn th·ªã ƒë·ªô kh√≥ b·∫±ng ti·∫øng Vi·ªát
                    let difficultyText = 'D·ªÖ';
                    if (record.difficulty === 'medium') {
                        difficultyText = 'TB';
                    } else if (record.difficulty === 'hard') {
                        difficultyText = 'Kh√≥';
                    }
                    
                    difficulty.textContent = difficultyText;
                    difficulty.style.marginRight = '10px';
                    
                    // Highlight b·∫£n ghi c√≥ ƒëi·ªÉm cao nh·∫•t
                    if (index === 0) {
                        item.style.backgroundColor = '#fff8e1';
                        rank.style.color = '#FFD700';
                    }
                    
                    item.appendChild(rank);
                    item.appendChild(name);
                    item.appendChild(score);
                    item.appendChild(difficulty);
                    
                    leaderboardList.appendChild(item);
                });
            }
        });
    </script>
</body>
</html>